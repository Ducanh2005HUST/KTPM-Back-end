{% extends 'base.html' %}
{% load static %}
{% load perms_extras %}

{% block content %}
<div class="content-area">
    <h2>Quản lý truy cập</h2>
    <p>Trang này dùng để tạo tài khoản và phân quyền cho các chức năng trong menu.</p>

    <div style="display:flex; gap:24px; align-items:flex-start;">
        <div style="flex:1; background:#fff; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.08);">
            <form method="post" action="">
                {% csrf_token %}
                <input type="hidden" name="action" value="create_user">
                
                <div style="margin-bottom:16px;">
                    <label style="display:block; margin-bottom:6px; font-weight:500; color:#333;">
                        <i class="fas fa-user"></i> Tên đăng nhập <span style="color:#d32f2f;">*</span>
                    </label>
                    <input name="username" required class="form-input" style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:6px; font-size:14px;">
                </div>
                
                <div style="margin-bottom:16px;">
                    <label style="display:block; margin-bottom:6px; font-weight:500; color:#333;">
                        <i class="fas fa-lock"></i> Mật khẩu <span style="color:#d32f2f;">*</span>
                    </label>
                    <input name="password" type="password" required class="form-input" style="width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:6px; font-size:14px;">
                </div>

                <div style="margin-bottom:16px;">
                    <label style="display:block; margin-bottom:10px; font-weight:600; color:#333; font-size:15px;">
                        <i class="fas fa-user-tag"></i> Chọn vai trò
                    </label>
                    <div style="border:2px solid #e3f2fd; border-radius:8px; padding:12px; background:#fafafa;">
                        <div style="margin-bottom:10px; padding:10px; background:white; border-radius:6px; border-left:4px solid #d32f2f;">
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                                <input type="radio" name="role" value="to_truong" style="width:18px; height:18px; cursor:pointer;">
                                <span style="flex:1;">
                                    <strong style="color:#d32f2f;">Tổ trưởng</strong>
                                    <br>
                                    <small style="color:#666;">Quản lý nhân khẩu, tạm trú/vắng, thống kê báo cáo</small>
                                </span>
                            </label>
                        </div>

                        <div style="margin-bottom:10px; padding:10px; background:white; border-radius:6px; border-left:4px solid #1565c0;">
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                                <input type="radio" name="role" value="to_pho" style="width:18px; height:18px; cursor:pointer;">
                                <span style="flex:1;">
                                    <strong style="color:#1565c0;">Tổ phó</strong>
                                    <br>
                                    <small style="color:#666;">Quản lý nhân khẩu, tạm trú/vắng, thống kê báo cáo</small>
                                </span>
                            </label>
                        </div>

                        <div style="padding:10px; background:white; border-radius:6px; border-left:4px solid #2e7d32;">
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                                <input type="radio" name="role" value="can_bo" style="width:18px; height:18px; cursor:pointer;">
                                <span style="flex:1;">
                                    <strong style="color:#2e7d32;">Cán bộ</strong>
                                    <br>
                                    <small style="color:#666;">Quản lý thu phí, thống kê báo cáo</small>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div style="text-align:center; margin-top:20px;">
                    <button class="btn primary" type="submit" style="padding:12px 32px; font-size:15px; font-weight:600; background:linear-gradient(135deg, #1565c0, #1976d2); border:none; border-radius:8px; color:white; cursor:pointer; display:inline-flex; align-items:center; gap:8px; box-shadow:0 4px 12px rgba(21,101,192,0.3); transition:all 0.3s;">
                        <i class="fas fa-save"></i> Tạo tài khoản
                    </button>
                </div>
            </form>
        </div>
    </div>

    <hr style="margin:40px 0; border:none; border-top:2px solid #e0e0e0;">
    
    <h3 style="color:#1565c0; display:flex; align-items:center; gap:8px; margin-bottom:20px;">
        <i class="fas fa-users"></i> Danh sách người dùng
    </h3>
    
    <div style="background:white; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.08); overflow:hidden;">
        <table class="table-basic" style="width:100%;">
            <thead style="background:linear-gradient(135deg, #e3f2fd, #bbdefb);">
                <tr>
                    <th style="padding:14px; text-align:left; color:#1565c0; font-weight:600;">
                        <i class="fas fa-user"></i> Tài khoản
                    </th>
                    <th style="padding:14px; text-align:left; color:#1565c0; font-weight:600;">
                        <i class="fas fa-shield-alt"></i> Quyền truy cập
                    </th>
                    <th style="padding:14px; text-align:center; color:#1565c0; font-weight:600;">
                        <i class="fas fa-cog"></i> Thao tác
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr style="border-bottom:1px solid #f0f0f0; transition:background 0.2s;" onmouseover="this.style.background='#fafafa'" onmouseout="this.style.background='white'">
                    <td style="padding:14px;">
                        <strong style="color:#333; font-size:15px;">{{ u.username }}</strong>
                        {% if u.is_staff %}
                        <span style="background:#4caf50; color:white; padding:2px 8px; border-radius:4px; font-size:11px; margin-left:8px;">ADMIN</span>
                        {% endif %}
                    </td>
                    <td style="padding:14px;">
                        {% if assignments|dict_get:u.id|dict_get:'qlnk' %}
                            <span style="background:#e3f2fd; color:#1565c0; padding:6px 12px; border-radius:6px; margin-right:6px; display:inline-flex; align-items:center; gap:4px; font-size:12px; font-weight:500; border:1px solid #bbdefb;">
                                <i class="fas fa-users" style="font-size:10px;"></i> Quản lý nhân khẩu
                            </span>
                        {% endif %}
                        {% if assignments|dict_get:u.id|dict_get:'thuphi' %}
                            <span style="background:#e8f5e9; color:#2e7d32; padding:6px 12px; border-radius:6px; margin-right:6px; display:inline-flex; align-items:center; gap:4px; font-size:12px; font-weight:500; border:1px solid #c8e6c9;">
                                <i class="fas fa-dollar-sign" style="font-size:10px;"></i> Thu phí
                            </span>
                        {% endif %}
                        {% if assignments|dict_get:u.id|dict_get:'tamtru' %}
                            <span style="background:#fff3e0; color:#f57c00; padding:6px 12px; border-radius:6px; margin-right:6px; display:inline-flex; align-items:center; gap:4px; font-size:12px; font-weight:500; border:1px solid #ffe0b2;">
                                <i class="fas fa-home" style="font-size:10px;"></i> Tạm trú/vắng
                            </span>
                        {% endif %}
                        {% if assignments|dict_get:u.id|dict_get:'thongke' %}
                            <span style="background:#f3e5f5; color:#7b1fa2; padding:6px 12px; border-radius:6px; margin-right:6px; display:inline-flex; align-items:center; gap:4px; font-size:12px; font-weight:500; border:1px solid #e1bee7;">
                                <i class="fas fa-chart-bar" style="font-size:10px;"></i> Thống kê
                            </span>
                        {% endif %}
                        {% if not assignments|dict_get:u.id or not assignments|dict_get:u.id|dict_get:'qlnk' and not assignments|dict_get:u.id|dict_get:'thuphi' and not assignments|dict_get:u.id|dict_get:'tamtru' and not assignments|dict_get:u.id|dict_get:'thongke' %}
                            <span style="color:#999; font-style:italic;">Chưa có quyền</span>
                        {% endif %}
                    </td>
                    <td style="padding:14px; text-align:center;">
                        <button onclick="editUser('{{ u.id }}', '{{ u.username }}')" style="background:#1565c0; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; display:inline-flex; align-items:center; gap:4px; transition:all 0.2s;" onmouseover="this.style.background='#0d47a1'" onmouseout="this.style.background='#1565c0'">
                            <i class="fas fa-edit"></i> Sửa quyền
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<link rel="stylesheet" href="{% static 'css/quanly_truycap.css' %}">
{% endblock %}
